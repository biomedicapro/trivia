<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Preguntas</title>
  <style>
    /* Reset y maximización de pantalla */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background-color: #fff;
      color: #000;
      font-family: sans-serif;
    }
    /* Cada "página" ocupa toda la pantalla */
    .page {
      display: none;
      height: 100%;
      width: 100%;
      box-sizing: border-box;
    }
    .active {
      display: block;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      background-color: #000;
      color: #fff;
    }
    .back-btn {
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    .folder-list {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }
    .folder-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 5px;
      border: 1px solid #000;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .folder-item:hover {
      background-color: #eee;
    }
    .folder-icon {
      font-size: 24px;
      margin-right: 10px;
    }
    .new-folder {
      margin-top: 10px;
    }
    input[type="text"] {
      width: calc(100% - 100px);
      padding: 8px;
      margin-right: 10px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 12px;
      background-color: #000;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 3px;
    }
    button:hover {
      background-color: #333;
    }
    textarea {
      width: 100%;
      height: 200px;
      padding: 10px;
      box-sizing: border-box;
      margin-top: 10px;
      resize: vertical;
      border: 1px solid #000;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <!-- Página de Categorías -->
  <div id="pageCategories" class="page active">
    <header>
      <h2>Categorías</h2>
    </header>
    <ul id="categoryList" class="folder-list"></ul>
    <div class="new-folder">
      <input type="text" id="newCategoryInput" placeholder="Nueva Categoría">
      <button onclick="addCategory()">Agregar</button>
    </div>
  </div>

  <!-- Página de Asignaturas -->
  <div id="pageSubjects" class="page">
    <header>
      <button class="back-btn" onclick="goBack('pageCategories')">&#x2190; Atrás</button>
      <h2>Asignaturas</h2>
      <span></span>
    </header>
    <ul id="subjectList" class="folder-list"></ul>
    <div class="new-folder">
      <input type="text" id="newSubjectInput" placeholder="Nueva Asignatura">
      <button onclick="addSubject()">Agregar</button>
    </div>
  </div>

  <!-- Página de Temas -->
  <div id="pageTopics" class="page">
    <header>
      <button class="back-btn" onclick="goBack('pageSubjects')">&#x2190; Atrás</button>
      <h2>Temas</h2>
      <span></span>
    </header>
    <ul id="topicList" class="folder-list"></ul>
    <div class="new-folder">
      <input type="text" id="newTopicInput" placeholder="Nuevo Tema">
      <button onclick="addTopic()">Agregar</button>
    </div>
  </div>

  <!-- Página de Creación del Mazo de Preguntas -->
  <div id="pageCreate" class="page">
    <header>
      <button class="back-btn" onclick="goBack('pageTopics')">&#x2190; Atrás</button>
      <h2>Crear Mazo</h2>
      <span></span>
    </header>
    <div>
      <p><strong>Formato para Test:</strong> pregunta, opción correcta/ opción 2/ opción 3/ opción 4, explicación, T; ...</p>
      <p><strong>Formato para Flashcard:</strong> pregunta, respuesta, explicación, F; ...</p>
      <textarea id="questionsInput" placeholder="Escribe tus preguntas aquí..."></textarea>
      <button onclick="submitQuestions()">Enviar Preguntas</button>
      <div id="responseMessage"></div>
    </div>
  </div>

  <script>
    // URL del Apps Script (reemplaza YOUR_SCRIPT_ID por el tuyo)
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzU2pbvxYOLotEw60fwnKIJmGRLABwp_odNXzj0hY18ZrpTBRmkpjcgGJYph6hzMTdy/exec';
    
    // Estructura de datos para almacenar la información de carpetas
    let data = { categories: [] };
    let selectedCategory = null;
    let selectedSubject = null;
    let selectedTopic = null;

    // Función para mostrar la página indicada y ocultar las demás
    function showPage(pageId) {
      const pages = document.querySelectorAll('.page');
      pages.forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
    }

    // Renderiza la lista de Categorías
    function renderCategories() {
      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = '';
      data.categories.forEach((cat, index) => {
        const li = document.createElement('li');
        li.className = 'folder-item';
        li.innerHTML = '<span class="folder-icon">&#128193;</span>' + cat.name;
        li.onclick = () => {
          selectedCategory = index;
          renderSubjects();
          showPage('pageSubjects');
        };
        categoryList.appendChild(li);
      });
    }

    // Renderiza la lista de Asignaturas de la Categoría seleccionada
    function renderSubjects() {
      const subjectList = document.getElementById('subjectList');
      subjectList.innerHTML = '';
      if (selectedCategory !== null) {
        data.categories[selectedCategory].subjects.forEach((sub, index) => {
          const li = document.createElement('li');
          li.className = 'folder-item';
          li.innerHTML = '<span class="folder-icon">&#128193;</span>' + sub.name;
          li.onclick = () => {
            selectedSubject = index;
            renderTopics();
            showPage('pageTopics');
          };
          subjectList.appendChild(li);
        });
      }
    }

    // Renderiza la lista de Temas de la Asignatura seleccionada
    function renderTopics() {
      const topicList = document.getElementById('topicList');
      topicList.innerHTML = '';
      if (selectedCategory !== null && selectedSubject !== null) {
        data.categories[selectedCategory].subjects[selectedSubject].topics.forEach((top, index) => {
          const li = document.createElement('li');
          li.className = 'folder-item';
          li.innerHTML = '<span class="folder-icon">&#128193;</span>' + top.name;
          li.onclick = () => {
            selectedTopic = index;
            showPage('pageCreate');
          };
          topicList.appendChild(li);
        });
      }
    }

    // Funciones para agregar nuevas carpetas (actualizan la estructura local)
    function addCategory() {
      const input = document.getElementById('newCategoryInput');
      const name = input.value.trim();
      if(name) {
        data.categories.push({ name: name, subjects: [] });
        input.value = '';
        renderCategories();
      }
    }

    function addSubject() {
      if(selectedCategory === null) {
        alert('Seleccione una categoría primero.');
        return;
      }
      const input = document.getElementById('newSubjectInput');
      const name = input.value.trim();
      if(name) {
        data.categories[selectedCategory].subjects.push({ name: name, topics: [] });
        input.value = '';
        renderSubjects();
      }
    }

    function addTopic() {
      if(selectedCategory === null || selectedSubject === null) {
        alert('Seleccione una categoría y una asignatura primero.');
        return;
      }
      const input = document.getElementById('newTopicInput');
      const name = input.value.trim();
      if(name) {
        data.categories[selectedCategory].subjects[selectedSubject].topics.push({ name: name });
        input.value = '';
        renderTopics();
      }
    }

    // Función para los botones "Atrás"
    function goBack(page) {
      showPage(page);
    }

    // Función para enviar las preguntas (se usa el mismo formato y la numeración se asigna en el Apps Script)
    function submitQuestions() {
      if(selectedCategory === null || selectedSubject === null || selectedTopic === null) {
        alert('Seleccione Categoría, Asignatura y Tema.');
        return;
      }
      const categoryName = data.categories[selectedCategory].name;
      const subjectName = data.categories[selectedCategory].subjects[selectedSubject].name;
      const topicName = data.categories[selectedCategory].subjects[selectedSubject].topics[selectedTopic].name;
      const questionsText = document.getElementById('questionsInput').value.trim();
      if(!questionsText) {
        alert('Ingrese las preguntas.');
        return;
      }
      const payload = {
        category: categoryName,
        subject: subjectName,
        topic: topicName,
        questions: questionsText
      };

      fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then(response => {
        document.getElementById('responseMessage').textContent = 'Preguntas enviadas exitosamente.';
        document.getElementById('questionsInput').value = '';
        loadFolderStructure();
        showPage('pageTopics');
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('responseMessage').textContent = 'Error al enviar las preguntas.';
      });
    }

    // Función para cargar la estructura de carpetas actualizada desde el Sheets
    function loadFolderStructure() {
      fetch(scriptURL)
      .then(response => response.json())
      .then(result => {
        if(result.status === 'success') {
          data = result.data; // Se espera { categories: [...] }
          // Reinicia las selecciones y muestra la pantalla de Categorías
          selectedCategory = null;
          selectedSubject = null;
          selectedTopic = null;
          renderCategories();
          showPage('pageCategories');
        } else {
          console.error('Error al obtener la estructura:', result.message);
        }
      })
      .catch(error => {
        console.error('Fetch error:', error);
      });
    }

    // Al cargar la página, se obtiene la estructura actualizada
    window.onload = function() {
      loadFolderStructure();
    }
  </script>
</body>
</html>
