<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QWeb ‚Äì Preguntas y Flashcards</title>
  <style>
    /* Estilos generales y minimalistas */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      color: #333;
      transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode {
      background-color: #222;
      color: #ddd;
    }
    header {
      background: #007bff;
      color: #fff;
      padding: 15px;
      text-align: center;
    }
    nav {
      background: #fff;
      display: flex;
      justify-content: center;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    nav button {
      background: none;
      border: none;
      margin: 0 15px;
      font-size: 16px;
      cursor: pointer;
    }
    .container {
      padding: 20px;
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      box-sizing: border-box;
    }
    button {
      padding: 10px 20px;
      cursor: pointer;
    }
    .alert {
      background: #d4edda;
      color: #155724;
      padding: 10px;
      margin: 10px 0;
      display: none;
    }
    /* Estilos para la interfaz de estudio/repaso en pantalla completa */
    .study-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }
    .study-content {
      flex: 1;
      display: flex;
    }
    .question-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .sidebar {
      width: 60px;
      background: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0;
    }
    .sidebar button {
      background: none;
      border: none;
      margin: 10px 0;
      font-size: 20px;
      cursor: pointer;
    }
    .progress-bar {
      height: 5px;
      background: #007bff;
      width: 0%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <header>
    <h1>QWeb ‚Äì Preguntas y Flashcards</h1>
  </header>
  <nav>
    <button onclick="showSection('crear')">Crear Preguntas</button>
    <button onclick="showSection('estudiar')">Estudiar</button>
    <button onclick="showSection('repasar')">Repasar</button>
    <button onclick="showSection('programar')">Programar Repaso</button>
  </nav>
  <div class="container">
    <!-- Secci√≥n para agregar preguntas -->
    <div id="crear" class="section active">
      <h2>Agregar Preguntas</h2>
      <p>Introduce las preguntas usando este formato:</p>
      <ul>
        <li><strong>Flashcards:</strong> "pregunta", "respuesta", "explicaci√≥n"; "pregunta", "respuesta", "explicaci√≥n"; ...</li>
        <li><strong>Tipo Test:</strong> "pregunta", "[opci√≥n correcta], [opci√≥n 2], [opci√≥n 3], ‚Ä¶", "explicaci√≥n"; ...</li>
      </ul>
      <!-- Seleccionar modo: nuevo mazo o agregar a existente -->
      <div>
        <label>
          <input type="radio" name="modoMazo" value="nuevo" checked onchange="toggleMazoMode()"> Crear nuevo mazo
        </label>
        <label>
          <input type="radio" name="modoMazo" value="existente" onchange="toggleMazoMode()"> Agregar a mazo existente
        </label>
      </div>
      <!-- Campos para nuevo mazo -->
      <div id="nuevoMazo">
        <input type="text" id="asignaturaNuevo" placeholder="Nueva Asignatura">
        <input type="text" id="temaNuevo" placeholder="Nuevo Tema">
      </div>
      <!-- Campos para mazo existente -->
      <div id="existenteMazo" style="display:none;">
        <select id="asignaturaExistente" onchange="cargarTemasExistente()">
          <option value="">-- Selecciona Asignatura Existente --</option>
        </select>
        <select id="temaExistente">
          <option value="">-- Selecciona Tema Existente --</option>
        </select>
      </div>
      <!-- Casilla para indicar USMLE -->
      <div>
        <label>
          <input type="checkbox" id="esUSMLE"> Grupo de preguntas USMLE
        </label>
      </div>
      <textarea id="preguntasInput" rows="6" placeholder="Escribe las preguntas separadas por ';'"></textarea>
      <button onclick="agregarPreguntas()">Agregar Preguntas</button>
      <div id="alertaExito" class="alert">¬°Preguntas agregadas exitosamente!</div>
    </div>
    <!-- Secci√≥n Estudiar -->
    <div id="estudiar" class="section">
      <h2>Selecciona Asignatura y Tema para Estudiar</h2>
      <select id="selectAsignatura" onchange="cargarTemas()">
        <option value="">-- Selecciona Asignatura --</option>
      </select>
      <select id="selectTema">
        <option value="">-- Selecciona Tema --</option>
      </select>
      <button onclick="iniciarEstudio()">Iniciar Estudio</button>
    </div>
    <!-- Secci√≥n Repasar -->
    <div id="repasar" class="section">
      <h2>Repasar Preguntas</h2>
      <select id="repasarAsignatura" onchange="cargarTemasRepaso()">
        <option value="">-- Selecciona Asignatura --</option>
      </select>
      <select id="repasarTema">
        <option value="">-- Selecciona Tema --</option>
      </select>
      <select id="repasarDificultad">
        <option value="">-- Selecciona Dificultad --</option>
        <option value="facil">F√°cil</option>
        <option value="medio">Medio</option>
        <option value="dificil">Dif√≠cil</option>
      </select>
      <label>
        <input type="checkbox" id="repasarUSMLE"> Es USMLE?
      </label>
      <button onclick="iniciarRepaso()">Iniciar Repaso</button>
    </div>
    <!-- Secci√≥n Programar Repaso -->
    <div id="programar" class="section">
      <h2>Programar Repaso</h2>
      <select id="progAsignatura">
        <option value="">-- Selecciona Asignatura --</option>
      </select>
      <select id="progTema">
        <option value="">-- Selecciona Tema --</option>
      </select>
      <select id="progDificultad">
        <option value="">-- Selecciona Dificultad --</option>
        <option value="facil">F√°cil</option>
        <option value="medio">Medio</option>
        <option value="dificil">Dif√≠cil</option>
      </select>
      <label>
        <input type="checkbox" id="progUSMLE"> Es USMLE?
      </label>
      <input type="datetime-local" id="progFecha">
      <button onclick="programarRepaso()">Programar Repaso</button>
      <div id="alertaProg" class="alert">¬°Repaso programado!</div>
      <div id="calendario" style="margin-top:20px;">
        <!-- Aqu√≠ se podr√≠a implementar un calendario visual -->
        <p>Calendario (pr√≥ximamente)</p>
      </div>
    </div>
  </div>

  <!-- Interfaz de estudio/repaso en pantalla completa -->
  <div id="interfazPregunta" class="study-fullscreen" style="display:none;">
    <div class="progress-bar" id="progressBar"></div>
    <div class="study-content">
      <div class="question-area" id="questionArea">
        <!-- Se mostrar√° la pregunta y opciones -->
      </div>
      <div class="sidebar">
        <button onclick="salirEstudio()" title="Salir">‚èèÔ∏è</button>
        <button onclick="toggleModo()" title="Modo D√≠a/Noche">üåó</button>
        <button onclick="clasificarPregunta('facil')" title="F√°cil">üëç</button>
        <button onclick="clasificarPregunta('medio')" title="Medio">üëå</button>
        <button onclick="clasificarPregunta('dificil')" title="Dif√≠cil">üëé</button>
        <button onclick="anteriorPregunta()" title="Anterior">‚¨ÖÔ∏è</button>
        <button onclick="siguientePregunta()" title="Siguiente">‚û°Ô∏è</button>
        <button onclick="cambiarCara()" title="Ver Respuesta">üîÑ</button>
      </div>
    </div>
  </div>

  <script>
    /* VARIABLES GLOBALES */
    let preguntas = [];              // Datos totales (cargados del Sheet)
    let preguntasFiltradas = [];     // Preguntas seg√∫n asignatura/tema (estudio o repaso)
    let indiceActual = 0;
    let modoOscuro = false;
    let enEstudio = false;
    let mostrandoRespuesta = false;

    /* NAVEGACI√ìN ENTRE SECCIONES */
    function showSection(seccion) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(seccion).classList.add('active');
    }

    /* TOGGLE ENTRE NUEVO MAZO Y MAZO EXISTENTE */
    function toggleMazoMode() {
      const modo = document.querySelector('input[name="modoMazo"]:checked').value;
      if (modo === 'nuevo') {
        document.getElementById('nuevoMazo').style.display = 'block';
        document.getElementById('existenteMazo').style.display = 'none';
      } else {
        document.getElementById('nuevoMazo').style.display = 'none';
        document.getElementById('existenteMazo').style.display = 'block';
        cargarAsignaturas('asignaturaExistente');
      }
    }

    /* CARGA DE DATOS DEL SHEET */
    function cargarDatos(callback) {
      fetch('YOUR_APPS_SCRIPT_WEB_APP_URL?action=obtener')
        .then(res => res.json())
        .then(data => { 
          preguntas = data; 
          if (callback) callback(); 
        })
        .catch(err => console.error(err));
    }

    /* CARGA DE ASIGNATURAS EN LOS SELECTS */
    function cargarAsignaturas(selectId) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">-- Selecciona Asignatura --</option>';
      let asignaturas = [...new Set(preguntas.map(p => p.asignatura))];
      asignaturas.forEach(a => {
        let option = document.createElement('option');
        option.value = a;
        option.textContent = a;
        select.appendChild(option);
      });
    }
    function cargarTemas() {
      const asignatura = document.getElementById('selectAsignatura').value;
      const select = document.getElementById('selectTema');
      select.innerHTML = '<option value="">-- Selecciona Tema --</option>';
      let temas = [...new Set(preguntas.filter(p => p.asignatura === asignatura).map(p => p.tema))];
      temas.forEach(t => {
        let option = document.createElement('option');
        option.value = t;
        option.textContent = t;
        select.appendChild(option);
      });
    }
    function cargarTemasExistente() {
      const asignatura = document.getElementById('asignaturaExistente').value;
      const select = document.getElementById('temaExistente');
      select.innerHTML = '<option value="">-- Selecciona Tema Existente --</option>';
      let temas = [...new Set(preguntas.filter(p => p.asignatura === asignatura).map(p => p.tema))];
      temas.forEach(t => {
        let option = document.createElement('option');
        option.value = t;
        option.textContent = t;
        select.appendChild(option);
      });
    }
    function cargarTemasRepaso() {
      const asignatura = document.getElementById('repasarAsignatura').value;
      const select = document.getElementById('repasarTema');
      select.innerHTML = '<option value="">-- Selecciona Tema --</option>';
      let temas = [...new Set(preguntas.filter(p => p.asignatura === asignatura).map(p => p.tema))];
      temas.forEach(t => {
        let option = document.createElement('option');
        option.value = t;
        option.textContent = t;
        select.appendChild(option);
      });
    }

    /* AL INICIAR, CARGAMOS DATOS Y POBLAMOS LOS SELECTS */
    window.onload = () => {
      cargarDatos(() => {
        cargarAsignaturas('selectAsignatura');
        cargarAsignaturas('repasarAsignatura');
        cargarAsignaturas('progAsignatura');
      });
    };

    /* AGREGAR PREGUNTAS */
    function agregarPreguntas() {
      const modo = document.querySelector('input[name="modoMazo"]:checked').value;
      let asignatura, tema;
      if (modo === "nuevo") {
        asignatura = document.getElementById('asignaturaNuevo').value.trim();
        tema = document.getElementById('temaNuevo').value.trim();
      } else {
        asignatura = document.getElementById('asignaturaExistente').value.trim();
        tema = document.getElementById('temaExistente').value.trim();
      }
      const preguntasTexto = document.getElementById('preguntasInput').value.trim();
      const esUSMLE = document.getElementById('esUSMLE').checked ? "true" : "false";
      if (!asignatura || !tema || !preguntasTexto) {
        alert("Por favor, completa todos los campos.");
        return;
      }
      const data = {
        action: 'agregar',
        asignatura: asignatura,
        tema: tema,
        esUSMLE: esUSMLE,
        contenido: preguntasTexto
      };
      fetch('YOUR_APPS_SCRIPT_WEB_APP_URL', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(() => {
        document.getElementById('preguntasInput').value = '';
        document.getElementById('alertaExito').style.display = 'block';
        setTimeout(() => { document.getElementById('alertaExito').style.display = 'none'; }, 2000);
      }).catch(err => {
        console.error(err);
        alert("Error al agregar preguntas.");
      });
    }

    /* INICIAR ESTUDIO */
    function iniciarEstudio() {
      const asignatura = document.getElementById('selectAsignatura').value;
      const tema = document.getElementById('selectTema').value;
      if (!asignatura || !tema) {
        alert("Selecciona asignatura y tema.");
        return;
      }
      preguntasFiltradas = preguntas.filter(p => p.asignatura === asignatura && p.tema === tema);
      if (preguntasFiltradas.length === 0) {
        alert("No hay preguntas para esta asignatura y tema.");
        return;
      }
      indiceActual = 0;
      mostrarPregunta();
      document.getElementById('interfazPregunta').style.display = 'block';
      document.documentElement.requestFullscreen().catch(err => console.error(err));
      enEstudio = true;
    }

    /* INICIAR REPASO (filtrado adicional por dificultad y USMLE) */
    function iniciarRepaso() {
      const asignatura = document.getElementById('repasarAsignatura').value;
      const tema = document.getElementById('repasarTema').value;
      const dificultad = document.getElementById('repasarDificultad').value;
      const esUSMLE = document.getElementById('repasarUSMLE').checked;
      preguntasFiltradas = preguntas.filter(p => {
        let cumple = true;
        if (asignatura) cumple = cumple && p.asignatura === asignatura;
        if (tema) cumple = cumple && p.tema === tema;
        if (dificultad) cumple = cumple && p.clasificacion === dificultad;
        if (esUSMLE) cumple = cumple && p.esUSMLE === "true";
        return cumple;
      });
      if (preguntasFiltradas.length === 0) {
        alert("No hay preguntas con esos criterios.");
        return;
      }
      indiceActual = 0;
      mostrarPregunta();
      document.getElementById('interfazPregunta').style.display = 'block';
      document.documentElement.requestFullscreen().catch(err => console.error(err));
      enEstudio = true;
    }

    /* MOSTRAR PREGUNTA ACTUAL */
    function mostrarPregunta() {
      if (indiceActual < 0 || indiceActual >= preguntasFiltradas.length) return;
      const q = preguntasFiltradas[indiceActual];
      mostrandoRespuesta = false;
      let html = `<h3>Pregunta ${indiceActual + 1} de ${preguntasFiltradas.length}</h3>`;
      html += `<p>${q.pregunta}</p>`;
      // Si "respuesta" contiene comas se asume pregunta tipo test
      if (q.respuesta.indexOf(',') > -1) {
        let opciones = q.respuesta.split(',').map(opt => opt.trim());
        opciones = shuffleArray(opciones);
        html += `<div id="opciones">`;
        opciones.forEach(opt => {
          html += `<button onclick="seleccionarOpcion('${opt}')">${opt}</button>`;
        });
        html += `</div>`;
        html += `<div id="feedback"></div>`;
      } else {
        // Flashcard: bot√≥n para ver/ocultar respuesta
        html += `<button onclick="cambiarCara()">Mostrar Respuesta</button>`;
        html += `<div id="respuesta" style="display:none;"><p>${q.respuesta}</p><p>${q.explicacion}</p></div>`;
      }
      document.getElementById('questionArea').innerHTML = html;
      actualizarProgress();
    }

    /* CAMBIAR CARA EN FLASHCARD */
    function cambiarCara() {
      const respuestaDiv = document.getElementById('respuesta');
      if (respuestaDiv) {
        respuestaDiv.style.display = (respuestaDiv.style.display === 'none') ? 'block' : 'none';
      }
    }

    /* SELECCI√ìN DE OPCI√ìN PARA PREGUNTAS TIPO TEST */
    function seleccionarOpcion(opcion) {
      const q = preguntasFiltradas[indiceActual];
      const feedbackDiv = document.getElementById('feedback');
      let opcionesOriginal = q.respuesta.split(',').map(opt => opt.trim());
      if (opcionesOriginal[0] === opcion) {
        feedbackDiv.innerHTML = '<p style="color:green;">¬°Correcto!</p>';
      } else {
        feedbackDiv.innerHTML = '<p style="color:red;">Incorrecto. Intenta de nuevo.</p>';
      }
    }

    /* NAVEGACI√ìN ENTRE PREGUNTAS */
    function siguientePregunta() {
      if (indiceActual < preguntasFiltradas.length - 1) {
        indiceActual++;
        mostrarPregunta();
      }
    }
    function anteriorPregunta() {
      if (indiceActual > 0) {
        indiceActual--;
        mostrarPregunta();
      }
    }

    /* SALIR DE LA INTERFAZ DE ESTUDIO/REPASO */
    function salirEstudio() {
      document.getElementById('interfazPregunta').style.display = 'none';
      if (document.fullscreenElement) document.exitFullscreen();
      enEstudio = false;
    }

    /* CAMBIAR MODO D√çA/NOCHE */
    function toggleModo() {
      modoOscuro = !modoOscuro;
      document.body.classList.toggle('dark-mode', modoOscuro);
    }

    /* GUARDAR CLASIFICACI√ìN DE LA PREGUNTA */
    function clasificarPregunta(dificultad) {
      const q = preguntasFiltradas[indiceActual];
      const data = {
        action: 'clasificar',
        id: q.id,
        clasificacion: dificultad
      };
      fetch('YOUR_APPS_SCRIPT_WEB_APP_URL', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).catch(err => console.error(err));
      q.clasificacion = dificultad;
      alert('Pregunta clasificada como ' + dificultad);
    }

    /* ACTUALIZAR BARRA DE PROGRESO */
    function actualizarProgress() {
      const progressBar = document.getElementById('progressBar');
      const porcentaje = ((indiceActual + 1) / preguntasFiltradas.length) * 100;
      progressBar.style.width = porcentaje + '%';
    }

    /* PROGRAMAR REPASO */
    function programarRepaso() {
      const asignatura = document.getElementById('progAsignatura').value;
      const tema = document.getElementById('progTema').value;
      const dificultad = document.getElementById('progDificultad').value;
      const esUSMLE = document.getElementById('progUSMLE').checked;
      const fecha = document.getElementById('progFecha').value;
      if (!asignatura || !tema || !fecha) {
        alert("Completa asignatura, tema y fecha.");
        return;
      }
      const data = {
        action: 'programar',
        asignatura: asignatura,
        tema: tema,
        dificultad: dificultad,
        esUSMLE: esUSMLE,
        fecha: fecha
      };
      fetch('YOUR_APPS_SCRIPT_WEB_APP_URL', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(() => {
        document.getElementById('alertaProg').style.display = 'block';
        setTimeout(() => { document.getElementById('alertaProg').style.display = 'none'; }, 2000);
      }).catch(err => console.error(err));
    }

    /* FUNCI√ìN UTILITARIA: MEZCLAR ELEMENTOS DE UN ARRAY */
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  </script>
</body>
</html>
