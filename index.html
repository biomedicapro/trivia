<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Aplicación de Preguntas</title>
  <style>
    /* ----------------- Global Styles ----------------- */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
    header { background: #333; color: #fff; padding: 10px; text-align: center; }
    nav button { margin: 0 5px; padding: 10px 20px; background: #444; color: #fff; border: none; cursor: pointer; }
    nav button.active { background: #008CBA; }
    section { display: none; padding: 20px; }
    section.active { display: block; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; }
    select, input[type="text"], textarea { width: 100%; padding: 8px; box-sizing: border-box; }
    textarea { height: 100px; }
    .checkbox-group { display: flex; align-items: center; }
    .checkbox-group input { margin-right: 5px; }
    button { cursor: pointer; }
    
    /* ----------------- Área de Estudio / Repaso ----------------- */
    #studyArea, #studyAreaRepaso {
      position: relative;
      background: #fff;
      margin: 20px auto;
      max-width: 800px;
      min-height: 400px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .card { position: relative; width: 100%; height: 100%; perspective: 1000px; }
    .card-inner { position: absolute; width: 100%; height: 100%; transition: transform 0.8s; transform-style: preserve-3d; }
    .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; padding: 20px; box-sizing: border-box; }
    .face-question { background: #fff; }
    .face-answer { background: #e0ffe0; transform: rotateY(180deg); }
    .face-explanation { background: #e0e0ff; transform: rotateY(180deg); }
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
    }
    .control-panel button { margin: 5px; padding: 5px 10px; }
    .dark-mode { background: #222; color: #eee; }
    
    /* ----------------- Calendario (simplificado) ----------------- */
    #calendar { max-width: 300px; margin: 20px auto; background: #fff; padding: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <h1>Aplicación de Preguntas</h1>
    <nav>
      <button id="navAgregar" class="active">Agregar Preguntas</button>
      <button id="navEstudiar">Estudiar Preguntas</button>
      <button id="navRepaso">Repaso</button>
    </nav>
  </header>
  
  <!-- Sección Agregar Preguntas -->
  <section id="sectionAgregar" class="active">
    <h2>Agregar Preguntas</h2>
    <div class="form-group">
      <label>Seleccionar Mazo Existente</label>
      <select id="selectAsignatura"></select>
      <select id="selectTema"></select>
    </div>
    <div class="form-group">
      <label>O crear nuevo mazo</label>
      <input type="text" id="newAsignatura" placeholder="Nueva Asignatura">
      <input type="text" id="newTema" placeholder="Nuevo Tema">
    </div>
    <div class="form-group checkbox-group">
      <input type="checkbox" id="checkUSMLE">
      <label for="checkUSMLE">USMLE</label>
    </div>
    <div class="form-group">
      <label>Entrada de Grupo de Preguntas (Formato Mixto)</label>
      <textarea id="inputPreguntas" placeholder="Ejemplos:
Flashcards:
  pregunta1, respuesta1, explicación1, F; pregunta2, respuesta2, explicación2, F;
Test:
  pregunta3, opción correcta / opción 2 / opción 3 / opción 4, explicación3, T; pregunta4, opción correcta / opción 2 / opción 3 / opción 4, explicación4, T;"></textarea>
    </div>
    <button id="btnAgregar">Agregar Preguntas</button>
    <div id="agregarStatus"></div>
  </section>
  
  <!-- Sección Estudiar Preguntas -->
  <section id="sectionEstudiar">
    <h2>Estudiar Preguntas</h2>
    <div class="form-group">
      <label>Selecciona Mazo de Estudio</label>
      <select id="selectEstudioAsignatura"></select>
      <select id="selectEstudioTema"></select>
    </div>
    <button id="btnIniciarEstudio">Iniciar Estudio</button>
    <div id="studyContainer" style="display:none;">
      <!-- Área de estudio a pantalla completa (para la pregunta) -->
      <div id="studyArea">
        <div class="card" id="studyCard">
          <div class="card-inner" id="cardInner">
            <div class="card-face face-question" id="faceQuestion"></div>
            <div class="card-face face-answer" id="faceAnswer"></div>
            <div class="card-face face-explanation" id="faceExplanation"></div>
          </div>
        </div>
        <div class="control-panel">
          <button id="btnToggleDayNight">Día/Noche</button>
          <button id="btnSalirEstudio">Salir</button>
          <button id="btnPrevFace">Anterior Cara</button>
          <button id="btnNextFace">Siguiente Cara</button>
          <button id="btnPrevQuestion">Pregunta Anterior</button>
          <button id="btnNextQuestion">Pregunta Siguiente</button>
          <button class="btnDificultad" data-dificultad="Fácil">Fácil</button>
          <button class="btnDificultad" data-dificultad="Medio">Medio</button>
          <button class="btnDificultad" data-dificultad="Difícil">Difícil</button>
        </div>
      </div>
    </div>
  </section>
  
  <!-- Sección Repaso -->
  <section id="sectionRepaso">
    <h2>Repaso</h2>
    <div class="form-group">
      <label>Filtrar Preguntas</label>
      <select id="filterAsignatura" multiple></select>
      <select id="filterTema" multiple></select>
      <select id="filterDificultad">
        <option value="">Todas</option>
        <option value="Fácil">Fácil</option>
        <option value="Medio">Medio</option>
        <option value="Difícil">Difícil</option>
      </select>
      <div class="checkbox-group">
        <input type="checkbox" id="filterUSMLE">
        <label for="filterUSMLE">USMLE</label>
      </div>
      <div class="form-group">
        <label>Modo Repaso</label>
        <select id="modoRepaso">
          <option value="inmediato">Repasar Inmediato</option>
          <option value="programado">Programar Repaso</option>
        </select>
      </div>
    </div>
    <div id="calendar" style="display:none;">
      <!-- Calendario visual (simplificado) -->
      <p>Calendario: Selecciona una fecha para programar el repaso</p>
      <input type="date" id="repasoFecha">
      <button id="btnProgramarRepaso">Programar</button>
    </div>
    <button id="btnIniciarRepaso">Iniciar Repaso</button>
    <div id="repasoContainer" style="display:none;">
      <!-- Reutiliza la misma interfaz de estudio -->
      <div id="studyAreaRepaso">
        <div class="card" id="repasoCard">
          <div class="card-inner" id="repasoCardInner">
            <div class="card-face face-question" id="repasoFaceQuestion"></div>
            <div class="card-face face-answer" id="repasoFaceAnswer"></div>
            <div class="card-face face-explanation" id="repasoFaceExplanation"></div>
          </div>
        </div>
        <div class="control-panel">
          <button id="btnToggleDayNightRepaso">Día/Noche</button>
          <button id="btnSalirRepaso">Salir</button>
          <button id="btnPrevFaceRepaso">Anterior Cara</button>
          <button id="btnNextFaceRepaso">Siguiente Cara</button>
          <button id="btnPrevQuestionRepaso">Pregunta Anterior</button>
          <button id="btnNextQuestionRepaso">Pregunta Siguiente</button>
          <button class="btnDificultadRepaso" data-dificultad="Fácil">Fácil</button>
          <button class="btnDificultadRepaso" data-dificultad="Medio">Medio</button>
          <button class="btnDificultadRepaso" data-dificultad="Difícil">Difícil</button>
        </div>
      </div>
      <div id="repasoInfo">
        <!-- Se mostrará la calificación y número de preguntas USMLE, si corresponde -->
      </div>
    </div>
  </section>
  
  <script>
    // ----------------- CONFIGURACIÓN -----------------
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwLvwTUKSOYtSb-2wqU2ZNrqx63KT39W8nm3bpylGDF_grpN7_f2CUcTt8uG6Ir7zGw/exec';
    
    // Variables globales para el estudio/repaso
    let preguntasEstudio = [];
    let indicePregunta = 0;
    let caraActual = 0; // 0: pregunta, 1: respuesta, 2: explicación

    // ----------------- NAVEGACIÓN ENTRE SECCIONES -----------------
    document.getElementById('navAgregar').addEventListener('click', () => showSection('sectionAgregar'));
    document.getElementById('navEstudiar').addEventListener('click', () => showSection('sectionEstudiar'));
    document.getElementById('navRepaso').addEventListener('click', () => { 
      showSection('sectionRepaso'); 
      loadFilters(); 
    });
    function showSection(sectionId){
      document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
    }
    
    // ----------------- CARGAR MAZOS (Asignaturas y Temas) -----------------
    function loadMazos(){
      fetch(SCRIPT_URL + '?action=getMazos')
        .then(response => response.json())
        .then(data => {
          populateSelect('selectAsignatura', data.asignaturas);
          populateSelect('selectTema', data.temas);
          populateSelect('selectEstudioAsignatura', data.asignaturas);
          populateSelect('selectEstudioTema', data.temas);
          populateSelect('filterAsignatura', data.asignaturas, true);
          populateSelect('filterTema', data.temas, true);
        })
        .catch(err => console.error(err));
    }
    function populateSelect(elementId, items, multiple = false){
      const select = document.getElementById(elementId);
      select.innerHTML = '';
      if(!multiple){
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Seleccionar --';
        select.appendChild(defaultOption);
      }
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
      });
    }
    
    // ----------------- AGREGAR PREGUNTAS -----------------
    document.getElementById('btnAgregar').addEventListener('click', () => {
      const asignatura = document.getElementById('newAsignatura').value || document.getElementById('selectAsignatura').value;
      const tema = document.getElementById('newTema').value || document.getElementById('selectTema').value;
      const usmle = document.getElementById('checkUSMLE').checked ? 'Sí' : '';
      const inputText = document.getElementById('inputPreguntas').value;
      
      if(!inputText.includes(',') || !inputText.includes(';')){
        alert('Formato de entrada incorrecto.');
        return;
      }
      
      const payload = {
        action: 'agregarPreguntas',
        asignatura: asignatura,
        tema: tema,
        usmle: usmle,
        preguntas: inputText
      };
      
      fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        document.getElementById('agregarStatus').textContent = data.status;
        loadMazos();
      })
      .catch(err => console.error(err));
    });
    
    // ----------------- ESTUDIAR PREGUNTAS -----------------
    document.getElementById('btnIniciarEstudio').addEventListener('click', () => {
      const asignatura = document.getElementById('selectEstudioAsignatura').value;
      const tema = document.getElementById('selectEstudioTema').value;
      if(!asignatura || !tema){
        alert('Seleccione asignatura y tema.');
        return;
      }
      fetch(SCRIPT_URL + '?action=getPreguntas&asignatura=' + encodeURIComponent(asignatura) + '&tema=' + encodeURIComponent(tema))
        .then(response => response.json())
        .then(data => {
          preguntasEstudio = data.preguntas;
          indicePregunta = 0;
          caraActual = 0;
          showStudyCard();
          document.getElementById('studyContainer').style.display = 'block';
          // Aquí se podría forzar el modo pantalla completa sobre el área (simulado)
        })
        .catch(err => console.error(err));
    });
    function showStudyCard(){
      if(preguntasEstudio.length === 0){
        alert('No hay preguntas para este mazo.');
        return;
      }
      const pregunta = preguntasEstudio[indicePregunta];
      const faceQuestion = document.getElementById('faceQuestion');
      const faceAnswer = document.getElementById('faceAnswer');
      const faceExplanation = document.getElementById('faceExplanation');
      
      if(pregunta.tipo === 'T'){
        // Pregunta test: se muestran pregunta y opciones en una misma cara
        let opciones = pregunta.opciones.split(' / ');
        opciones = opciones.sort(() => Math.random() - 0.5);
        faceQuestion.innerHTML = '<h3>' + pregunta.pregunta + '</h3><ul>' + opciones.map(opt => '<li class="option">' + opt + '</li>').join('') + '</ul>';
      } else {
        faceQuestion.innerHTML = '<h3>' + pregunta.pregunta + '</h3>';
      }
      faceAnswer.innerHTML = '<p>' + pregunta.respuesta + '</p>';
      faceExplanation.innerHTML = '<p>' + pregunta.explicacion + '</p>';
      document.getElementById('cardInner').style.transform = 'rotateY(0deg)';
    }
    
    // Navegación entre caras
    document.getElementById('btnNextFace').addEventListener('click', () => {
      caraActual = (caraActual + 1) % 3;
      updateCardFace();
    });
    document.getElementById('btnPrevFace').addEventListener('click', () => {
      caraActual = (caraActual + 2) % 3;
      updateCardFace();
    });
    function updateCardFace(){
      if(caraActual === 0){
        document.getElementById('cardInner').style.transform = 'rotateY(0deg)';
      } else if(caraActual === 1){
        document.getElementById('cardInner').style.transform = 'rotateY(180deg)';
      } else {
        // Para la tercera cara (explicación) se puede mantener la misma rotación, ya que se muestran en otra sección
        document.getElementById('cardInner').style.transform = 'rotateY(180deg)';
      }
    }
    
    document.getElementById('btnNextQuestion').addEventListener('click', () => {
      if(indicePregunta < preguntasEstudio.length - 1){
        indicePregunta++;
        caraActual = 0;
        showStudyCard();
      }
    });
    document.getElementById('btnPrevQuestion').addEventListener('click', () => {
      if(indicePregunta > 0){
        indicePregunta--;
        caraActual = 0;
        showStudyCard();
      }
    });
    
    // Actualización de dificultad
    document.querySelectorAll('.btnDificultad').forEach(btn => {
      btn.addEventListener('click', function(){
        const dificultad = this.getAttribute('data-dificultad');
        actualizarDificultad(preguntasEstudio[indicePregunta].id, dificultad);
      });
    });
    function actualizarDificultad(id, dificultad){
      const payload = {
        action: 'actualizarDificultad',
        id: id,
        dificultad: dificultad
      };
      fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => { console.log('Dificultad actualizada'); })
      .catch(err => console.error(err));
    }
    
    // Toggle día/noche y salir del estudio
    document.getElementById('btnToggleDayNight').addEventListener('click', () => {
      document.getElementById('studyArea').classList.toggle('dark-mode');
    });
    document.getElementById('btnSalirEstudio').addEventListener('click', () => {
      document.getElementById('studyContainer').style.display = 'none';
    });
    
    // ----------------- SECCIÓN REPASO -----------------
    function loadFilters(){
      // Opcionalmente, se pueden recargar los selectores de filtros si han cambiado
      loadMazos();
    }
    
    document.getElementById('modoRepaso').addEventListener('change', function(){
      document.getElementById('calendar').style.display = (this.value === 'programado') ? 'block' : 'none';
    });
    
    document.getElementById('btnProgramarRepaso').addEventListener('click', () => {
      alert('Repaso programado para: ' + document.getElementById('repasoFecha').value);
      // Aquí se podría enviar la programación al backend y actualizar un calendario visual
    });
    
    document.getElementById('btnIniciarRepaso').addEventListener('click', () => {
      const asignaturas = Array.from(document.getElementById('filterAsignatura').selectedOptions).map(o => o.value);
      const temas = Array.from(document.getElementById('filterTema').selectedOptions).map(o => o.value);
      const dificultad = document.getElementById('filterDificultad').value;
      const usmle = document.getElementById('filterUSMLE').checked ? 'Sí' : '';
      let query = '?action=getPreguntas&';
      if(asignaturas.length > 0) query += 'asignaturas=' + encodeURIComponent(asignaturas.join(',')) + '&';
      if(temas.length > 0) query += 'temas=' + encodeURIComponent(temas.join(',')) + '&';
      if(dificultad) query += 'dificultad=' + encodeURIComponent(dificultad) + '&';
      if(usmle) query += 'usmle=' + encodeURIComponent(usmle) + '&';
      
      fetch(SCRIPT_URL + query)
        .then(response => response.json())
        .then(data => {
          preguntasEstudio = data.preguntas;
          indicePregunta = 0;
          caraActual = 0;
          showStudyCard();
          document.getElementById('repasoContainer').style.display = 'block';
          if(usmle){
            document.getElementById('repasoInfo').textContent = 'Calificación: 85% - Preguntas USMLE: ' + preguntasEstudio.length;
          }
        })
        .catch(err => console.error(err));
    });
    
    // Toggle día/noche en repaso y salir
    document.getElementById('btnToggleDayNightRepaso').addEventListener('click', () => {
      document.getElementById('studyAreaRepaso').classList.toggle('dark-mode');
    });
    document.getElementById('btnSalirRepaso').addEventListener('click', () => {
      document.getElementById('repasoContainer').style.display = 'none';
    });
    
    // Cargar mazos al iniciar
    loadMazos();
  </script>
</body>
</html>
