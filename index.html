<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Aplicación de Preguntas</title>
  <style>
    /* Estilos Globales */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    header {
      background-color: #333;
      color: #fff;
      padding: 10px;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      background-color: #444;
    }
    nav button {
      background: none;
      border: none;
      color: #fff;
      padding: 15px 20px;
      cursor: pointer;
      font-size: 16px;
    }
    nav button.active {
      background-color: #666;
    }
    .container {
      padding: 20px;
    }
    /* Secciones */
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    /* Formularios */
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
    }
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
    textarea {
      height: 100px;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px;
    }
    /* Tarjetas de Estudio */
    .tarjeta {
      background-color: #fff;
      padding: 20px;
      margin: 10px auto;
      border-radius: 5px;
      max-width: 600px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      transition: all 0.5s ease;
    }
    .tarjeta.hidden {
      opacity: 0;
      transform: translateX(-100%);
    }
    .tarjeta.visible {
      opacity: 1;
      transform: translateX(0);
    }
    .nav-estudio {
      text-align: center;
      margin-top: 20px;
    }
    .icon-panel {
      margin-top: 15px;
      text-align: center;
    }
    .icon-panel button {
      margin: 0 10px;
      padding: 10px;
      font-size: 16px;
    }
    /* Sección Repaso */
    .calendario {
      margin: 20px 0;
    }
    .filter-group {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Aplicación de Preguntas</h1>
  </header>
  <nav>
    <button id="nav-agregar" class="active">Agregar Preguntas</button>
    <button id="nav-estudiar">Estudiar Preguntas</button>
    <button id="nav-repaso">Repaso</button>
  </nav>
  <div class="container">
    <!-- Sección Agregar Preguntas -->
    <div id="seccion-agregar" class="section active">
      <h2>Agregar Preguntas</h2>
      <div class="form-group">
        <label>Seleccionar Mazo Existente</label>
        <select id="select-asignatura"></select>
        <select id="select-tema"></select>
      </div>
      <div class="form-group">
        <button id="btn-nuevo-mazo">Nuevo Mazo</button>
        <div id="nuevo-mazo-fields" style="display:none;">
          <input type="text" id="nuevo-asignatura" placeholder="Nueva Asignatura">
          <input type="text" id="nuevo-tema" placeholder="Nuevo Tema">
        </div>
      </div>
      <div class="form-group">
        <label><input type="checkbox" id="usmle-checkbox"> USMLE</label>
      </div>
      <div class="form-group">
        <label>Entrada de Grupo de Preguntas (Formato mixto)</label>
        <textarea id="entrada-preguntas" placeholder='Ejemplos:
Flashcards: pregunta1, respuesta1, explicación1, F; pregunta2, respuesta2, explicación2, F;
Test: pregunta3, opción1 / opción2 / opción3 / opción4, explicación3, T; pregunta4, opción1 / opción2 / opción3 / opción4, explicación4, T;'></textarea>
      </div>
      <div class="form-group">
        <button id="btn-agregar">Agregar Preguntas</button>
      </div>
      <div id="mensaje-agregar"></div>
    </div>

    <!-- Sección Estudiar Preguntas -->
    <div id="seccion-estudiar" class="section">
      <h2>Estudiar Preguntas</h2>
      <div class="form-group">
        <label>Seleccionar Asignatura</label>
        <select id="select-estudio-asignatura"></select>
      </div>
      <div class="form-group">
        <label>Seleccionar Tema</label>
        <select id="select-estudio-tema"></select>
      </div>
      <div class="form-group">
        <button id="btn-iniciar-estudio">Iniciar Estudio (Pantalla Completa)</button>
      </div>
      <div id="contenedor-estudio" style="display:none;">
        <div id="tarjeta-estudio" class="tarjeta hidden"></div>
        <div class="nav-estudio">
          <button id="btn-anterior">Anterior</button>
          <span id="contador-pregunta"></span>
          <button id="btn-siguiente">Siguiente</button>
        </div>
        <div class="icon-panel">
          <button data-dificultad="Fácil" class="btn-dificultad">Fácil</button>
          <button data-dificultad="Medio" class="btn-dificultad">Medio</button>
          <button data-dificultad="Difícil" class="btn-dificultad">Difícil</button>
        </div>
      </div>
      <div id="mensaje-estudio"></div>
    </div>

    <!-- Sección Repaso -->
    <div id="seccion-repaso" class="section">
      <h2>Repaso</h2>
      <div class="form-group">
        <label>Filtros Avanzados</label>
        <div class="filter-group">
          <select id="filtro-asignatura" multiple size="4"></select>
        </div>
        <div class="filter-group">
          <select id="filtro-tema" multiple size="4"></select>
        </div>
        <div class="filter-group">
          <select id="filtro-dificultad">
            <option value="">Todas las dificultades</option>
            <option value="Fácil">Fácil</option>
            <option value="Medio">Medio</option>
            <option value="Difícil">Difícil</option>
          </select>
        </div>
        <div class="filter-group">
          <label><input type="checkbox" id="filtro-usmle"> USMLE</label>
        </div>
        <div class="filter-group">
          <label>Timer (segundos):</label>
          <input type="text" id="filtro-timer" placeholder="0 para desactivar">
        </div>
        <div class="filter-group calendario">
          <label>Programar Sesión (Calendario):</label>
          <input type="date" id="programar-sesion">
        </div>
        <div class="form-group">
          <button id="btn-iniciar-repaso">Iniciar Sesión de Repaso</button>
        </div>
      </div>
      <div id="contenedor-repaso" style="display:none;">
        <div id="repaso-lista"></div>
        <div id="timer-display"></div>
        <div id="calificacion-usmle"></div>
      </div>
      <div id="mensaje-repaso"></div>
    </div>
  </div>

  <script>
    // URL del Apps Script (reemplaza YOUR_SCRIPT_ID)
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxcaQA4QRN6h9UXJvxzPpls9QMAzpTaa4NaO5ZIGKhzD2RMJuWyQhgSK9cWJpG_uHFy/exec';

    // Variables globales para la sección de estudio y mapeo de mazos
    let preguntasEstudio = [];
    let indiceActual = 0;
    let mazoMapping = {}; // Objeto: asignatura -> Set(temas)

    // Navegación entre secciones
    document.getElementById("nav-agregar").addEventListener("click", () => showSection("seccion-agregar"));
    document.getElementById("nav-estudiar").addEventListener("click", () => showSection("seccion-estudiar"));
    document.getElementById("nav-repaso").addEventListener("click", () => showSection("seccion-repaso"));

    function showSection(sectionId) {
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(sectionId).classList.add("active");
      document.querySelectorAll("nav button").forEach(btn => btn.classList.remove("active"));
      document.getElementById("nav-" + sectionId.split('-')[1]).classList.add("active");
    }

    // Manejo de "Nuevo Mazo"
    document.getElementById("btn-nuevo-mazo").addEventListener("click", () => {
      const nuevoMazoDiv = document.getElementById("nuevo-mazo-fields");
      nuevoMazoDiv.style.display = (nuevoMazoDiv.style.display === "none") ? "block" : "none";
    });

    // Función para actualizar las opciones de temas según la asignatura seleccionada
    function actualizarTemas(asignaturaSelectId, temaSelectId, mapping, multiple = false) {
      const asignaturaSelect = document.getElementById(asignaturaSelectId);
      const temaSelect = document.getElementById(temaSelectId);
      temaSelect.innerHTML = "";
      let asignaturas = [];
      if (multiple) {
        asignaturas = Array.from(asignaturaSelect.selectedOptions).map(opt => opt.value);
      } else {
        asignaturas = [asignaturaSelect.value];
      }
      let temasSet = new Set();
      asignaturas.forEach(asignatura => {
        if (mapping[asignatura]) {
          mapping[asignatura].forEach(tema => temasSet.add(tema));
        }
      });
      temasSet.forEach(tema => {
        let option = document.createElement("option");
        option.value = tema;
        option.textContent = tema;
        temaSelect.appendChild(option);
      });
    }

    // Cargar mazos existentes y construir el mapping (asignatura -> temas)
    function cargarMazos() {
      fetch(APPS_SCRIPT_URL + '?action=getMazos')
        .then(response => response.json())
        .then(data => {
          // Construir el mapping
          mazoMapping = {};
          data.forEach(mazo => {
            if (!mazoMapping[mazo.asignatura]) {
              mazoMapping[mazo.asignatura] = new Set();
            }
            mazoMapping[mazo.asignatura].add(mazo.tema);
          });
          // Sección Agregar
          const selectAsignatura = document.getElementById("select-asignatura");
          selectAsignatura.innerHTML = "";
          for (let asignatura in mazoMapping) {
            let option = document.createElement("option");
            option.value = asignatura;
            option.textContent = asignatura;
            selectAsignatura.appendChild(option);
          }
          actualizarTemas("select-asignatura", "select-tema", mazoMapping);
          // Sección Estudiar
          const selectEstudioAsignatura = document.getElementById("select-estudio-asignatura");
          selectEstudioAsignatura.innerHTML = "";
          for (let asignatura in mazoMapping) {
            let option = document.createElement("option");
            option.value = asignatura;
            option.textContent = asignatura;
            selectEstudioAsignatura.appendChild(option);
          }
          actualizarTemas("select-estudio-asignatura", "select-estudio-tema", mazoMapping);
          // Sección Repaso: Filtro asignatura (múltiple)
          const filtroAsignatura = document.getElementById("filtro-asignatura");
          filtroAsignatura.innerHTML = "";
          for (let asignatura in mazoMapping) {
            let option = document.createElement("option");
            option.value = asignatura;
            option.textContent = asignatura;
            filtroAsignatura.appendChild(option);
          }
          actualizarTemas("filtro-asignatura", "filtro-tema", mazoMapping, true);

          // Agregar event listeners para actualización dependiente
          document.getElementById("select-asignatura").addEventListener("change", () => {
            actualizarTemas("select-asignatura", "select-tema", mazoMapping);
          });
          document.getElementById("select-estudio-asignatura").addEventListener("change", () => {
            actualizarTemas("select-estudio-asignatura", "select-estudio-tema", mazoMapping);
          });
          document.getElementById("filtro-asignatura").addEventListener("change", () => {
            actualizarTemas("filtro-asignatura", "filtro-tema", mazoMapping, true);
          });
        })
        .catch(err => console.error("Error cargando mazos:", err));
    }

    // Función para Agregar Preguntas
    document.getElementById("btn-agregar").addEventListener("click", () => {
      const usmle = document.getElementById("usmle-checkbox").checked;
      let asignatura = document.getElementById("select-asignatura").value;
      let tema = document.getElementById("select-tema").value;
      // Si se está creando un nuevo mazo:
      if (document.getElementById("nuevo-mazo-fields").style.display === "block") {
        asignatura = document.getElementById("nuevo-asignatura").value;
        tema = document.getElementById("nuevo-tema").value;
      }
      const entrada = document.getElementById("entrada-preguntas").value;
      const payload = {
        asignatura: asignatura,
        tema: tema,
        usmle: usmle,
        entrada: entrada
      };
      fetch(APPS_SCRIPT_URL + '?action=addPreguntas', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(() => {
        document.getElementById("mensaje-agregar").textContent = "Preguntas agregadas correctamente.";
        cargarMazos();
      })
      .catch(err => {
        document.getElementById("mensaje-agregar").textContent = "Error al agregar preguntas.";
        console.error(err);
      });
    });

    // Iniciar la sección de Estudio
    document.getElementById("btn-iniciar-estudio").addEventListener("click", () => {
      const asignatura = document.getElementById("select-estudio-asignatura").value;
      const tema = document.getElementById("select-estudio-tema").value;
      fetch(APPS_SCRIPT_URL + '?action=getPreguntas&asignatura=' + encodeURIComponent(asignatura) + '&tema=' + encodeURIComponent(tema))
      .then(response => response.json())
      .then(data => {
        preguntasEstudio = data;
        indiceActual = 0;
        if (preguntasEstudio.length > 0) {
          iniciarPantallaCompleta();
          mostrarPregunta(indiceActual);
          document.getElementById("contenedor-estudio").style.display = "block";
        } else {
          document.getElementById("mensaje-estudio").textContent = "No hay preguntas para este mazo.";
        }
      })
      .catch(err => console.error("Error cargando preguntas:", err));
    });

    // Forzar pantalla completa
    function iniciarPantallaCompleta() {
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.mozRequestFullScreen) {
        elem.mozRequestFullScreen();
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
    }

    // Mostrar la pregunta en la sección de Estudio
    function mostrarPregunta(index) {
      const tarjeta = document.getElementById("tarjeta-estudio");
      const preguntaObj = preguntasEstudio[index];
      tarjeta.classList.remove("hidden");
      tarjeta.classList.add("visible");
      
      if (preguntaObj["Test o Flashcard"] === "T") {
        // Pregunta de tipo Test: separa opciones usando "/" y quita espacios extra.
        const opciones = preguntaObj["Respuesta"].split("/").map(opt => opt.trim());
        let html = "<h3>" + preguntaObj["Pregunta"] + "</h3>";
        html += "<ul>";
        opciones.forEach(opcion => {
          html += `<li><button class="opcion-btn" data-respuesta="${opcion}">${opcion}</button></li>`;
        });
        html += "</ul>";
        html += "<p class='explicacion' style='display:none;'>" + preguntaObj["Explicación"] + "</p>";
        tarjeta.innerHTML = html;
        document.querySelectorAll(".opcion-btn").forEach(btn => {
          btn.addEventListener("click", function() {
            // La primera opción es la correcta
            if (btn.dataset.respuesta === opciones[0]) {
              btn.style.backgroundColor = "lightgreen";
            } else {
              btn.style.backgroundColor = "lightcoral";
            }
            tarjeta.querySelector(".explicacion").style.display = "block";
          });
        });
      } else {
        // Pregunta de tipo Flashcard: se muestra la pregunta con un botón para alternar la respuesta.
        let html = "<h3>" + preguntaObj["Pregunta"] + "</h3>";
        html += "<p class='respuesta' style='display:none;'>" + preguntaObj["Respuesta"] + "</p>";
        html += "<p class='explicacion' style='display:none;'>" + preguntaObj["Explicación"] + "</p>";
        html += "<button class='btn-toggle'>Mostrar Respuesta</button>";
        tarjeta.innerHTML = html;
        tarjeta.querySelector('.btn-toggle').addEventListener("click", function() {
          const respuestaEl = tarjeta.querySelector(".respuesta");
          const explicacionEl = tarjeta.querySelector(".explicacion");
          if (respuestaEl.style.display === "none") {
            respuestaEl.style.display = "block";
            explicacionEl.style.display = "block";
            this.textContent = "Ocultar Respuesta";
          } else {
            respuestaEl.style.display = "none";
            explicacionEl.style.display = "none";
            this.textContent = "Mostrar Respuesta";
          }
        });
      }
      document.getElementById("contador-pregunta").textContent = (index + 1) + " / " + preguntasEstudio.length;
    }

    // Botones de navegación en Estudio
    document.getElementById("btn-siguiente").addEventListener("click", () => {
      if (indiceActual < preguntasEstudio.length - 1) {
        indiceActual++;
        mostrarPregunta(indiceActual);
      }
    });
    document.getElementById("btn-anterior").addEventListener("click", () => {
      if (indiceActual > 0) {
        indiceActual--;
        mostrarPregunta(indiceActual);
      }
    });

    // Actualizar dificultad (envío inmediato)
    document.querySelectorAll(".btn-dificultad").forEach(btn => {
      btn.addEventListener("click", () => {
        const dificultad = btn.dataset.dificultad;
        const preguntaObj = preguntasEstudio[indiceActual];
        const payload = {
          asignatura: preguntaObj["Asignatura"],
          tema: preguntaObj["Tema"],
          id: preguntaObj["id#"],
          dificultad: dificultad
        };
        fetch(APPS_SCRIPT_URL + '?action=updateDificultad', {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        .then(() => {
          alert("Dificultad actualizada a " + dificultad);
        })
        .catch(err => console.error("Error actualizando dificultad:", err));
      });
    });

    // Sección Repaso: Iniciar sesión de repaso
    document.getElementById("btn-iniciar-repaso").addEventListener("click", () => {
      const filtroAsignaturas = Array.from(document.getElementById("filtro-asignatura").selectedOptions).map(opt => opt.value);
      const filtroTemas = Array.from(document.getElementById("filtro-tema").selectedOptions).map(opt => opt.value);
      const filtroDificultad = document.getElementById("filtro-dificultad").value;
      const filtroUsmle = document.getElementById("filtro-usmle").checked;
      const timerVal = parseInt(document.getElementById("filtro-timer").value, 10);
      const programarSesion = document.getElementById("programar-sesion").value;
      let query = `action=getPreguntas&`;
      if (filtroAsignaturas.length > 0) {
        query += "asignatura=" + encodeURIComponent(filtroAsignaturas.join(",")) + "&";
      }
      if (filtroTemas.length > 0) {
        query += "tema=" + encodeURIComponent(filtroTemas.join(",")) + "&";
      }
      if (filtroDificultad) {
        query += "dificultad=" + encodeURIComponent(filtroDificultad) + "&";
      }
      if (filtroUsmle) {
        query += "usmle=true&";
      }
      if (programarSesion) {
        query += "programar=" + encodeURIComponent(programarSesion) + "&";
      }
      fetch(APPS_SCRIPT_URL + '?' + query)
      .then(response => response.json())
      .then(data => {
        const repasoContenedor = document.getElementById("contenedor-repaso");
        repasoContenedor.style.display = "block";
        const repasoLista = document.getElementById("repaso-lista");
        repasoLista.innerHTML = "";
        data.forEach(preg => {
          repasoLista.innerHTML += `<div class="tarjeta"><h3>${preg.Pregunta}</h3><p>${preg.Respuesta}</p><p>${preg.Explicación}</p></div>`;
        });
        if (timerVal > 0) {
          iniciarTimer(timerVal);
        }
        if (filtroUsmle) {
          document.getElementById("calificacion-usmle").textContent = "Calificación: 85%";
        }
      })
      .catch(err => console.error("Error en repaso:", err));
    });

    // Función de Timer
    function iniciarTimer(segundos) {
      const display = document.getElementById("timer-display");
      let remaining = segundos;
      display.textContent = "Tiempo: " + remaining + "s";
      const interval = setInterval(() => {
        remaining--;
        display.textContent = "Tiempo: " + remaining + "s";
        if (remaining <= 0) {
          clearInterval(interval);
          display.textContent = "Tiempo terminado.";
        }
      }, 1000);
    }

    // Inicialización
    cargarMazos();
  </script>
</body>
</html>
