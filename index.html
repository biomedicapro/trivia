<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor de Preguntas</title>
  <style>
    /* Estilos básicos y minimalistas */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      transition: background 0.3s, color 0.3s;
    }
    header {
      background: #333;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: center;
    }
    header button {
      background: #555;
      color: #fff;
      border: none;
      padding: 10px 20px;
      margin: 0 5px;
      cursor: pointer;
    }
    header button.active {
      background: #777;
    }
    .container {
      padding: 20px;
    }
    .hidden {
      display: none;
    }
    .question-row {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
    }
    /* Estilos para la interfaz de estudio a pantalla completa */
    .study-interface {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    .study-header {
      background: #333;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .study-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      text-align: center;
    }
    .options {
      margin-top: 10px;
    }
    .option {
      margin: 5px;
      padding: 10px;
      border: 1px solid #ccc;
      cursor: pointer;
      display: inline-block;
    }
    .right-panel {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
    }
    .right-panel button {
      margin: 5px;
      padding: 10px;
    }
    .dark-mode {
      background: #222;
      color: #eee;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #aaa;
    }
    th, td {
      padding: 5px;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <button id="agregarTab" class="active">Agregar Preguntas</button>
    <button id="estudiarTab">Estudiar Preguntas</button>
  </header>

  <!-- Sección Agregar Preguntas -->
  <div id="agregarSection" class="container">
    <h2>Agregar Preguntas</h2>
    <form id="addQuestionForm">
      <label>Asignatura: <input type="text" name="asignatura" required></label><br><br>
      <label>Tema: <input type="text" name="tema" required></label><br><br>
      <label><input type="checkbox" name="usmle"> USMLE?</label><br><br>
      <div id="questionsContainer">
        <!-- Se agregarán filas dinámicas para cada pregunta -->
      </div>
      <button type="button" id="addRowBtn">Agregar fila de pregunta</button><br><br>
      <button type="submit">Enviar Preguntas</button>
    </form>
    <hr>
    <h3>Preguntas Disponibles</h3>
    <button type="button" id="refreshQuestions">Cargar Preguntas</button>
    <div id="questionsList">
      <!-- Se mostrará una tabla con las preguntas obtenidas del sheet -->
    </div>
  </div>

  <!-- Sección Estudiar Preguntas -->
  <div id="estudiarSection" class="container hidden">
    <h2>Estudiar Preguntas</h2>
    <label>Asignatura:
      <input type="text" id="studyAsignatura">
    </label>
    <label>Tema:
      <input type="text" id="studyTema">
    </label>
    <button id="loadStudyBtn">Cargar Preguntas</button>
    <div id="studyInterface" class="study-interface hidden">
      <div class="study-header">
        <span id="questionProgress">Pregunta 0/0</span>
        <div>
          <button id="toggleDarkBtn">Modo Día/Noche</button>
          <button id="exitStudyBtn">Salir</button>
        </div>
      </div>
      <div class="study-content">
        <div id="questionCard">
          <!-- Se mostrará la pregunta -->
        </div>
        <div id="optionsContainer" class="options"></div>
        <button id="flipCardBtn" class="hidden">Mostrar Respuesta</button>
      </div>
      <div class="right-panel">
        <button id="easyBtn">Fácil</button>
        <button id="mediumBtn">Medio</button>
        <button id="hardBtn">Difícil</button>
        <button id="prevBtn">Anterior</button>
        <button id="nextBtn">Siguiente</button>
      </div>
    </div>
  </div>

  <script>
    // URL del Apps Script (reemplazar 'YOUR_SCRIPT_ID' por el ID correspondiente)
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyCTOSMbrmXEKY2edyQNMZTeAE9DPOy80VH55IwBMphfu-Zn9j3ZkTYFcI-DmanI0Ry/exec';

    /* ---------------------------
       Sección: Agregar Preguntas
    -----------------------------*/
    // Función para crear una fila de pregunta en el formulario
    function createQuestionRow() {
      const row = document.createElement('div');
      row.className = 'question-row';
      row.innerHTML = `
        <label>Pregunta: <input type="text" name="pregunta" required></label><br>
        <label>Respuesta (para test: separe opciones con "|"): <input type="text" name="respuesta" required></label><br>
        <label>Explicación: <input type="text" name="explicacion"></label><br>
        <label>Tipo:
          <select name="tipo">
            <option value="T">Test</option>
            <option value="F">Flashcard</option>
          </select>
        </label>
        <button type="button" class="removeRowBtn">Eliminar fila</button>
      `;
      // Eliminar fila al hacer clic
      row.querySelector('.removeRowBtn').addEventListener('click', () => {
        row.remove();
      });
      return row;
    }
    // Agrega una fila inicial al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('questionsContainer').appendChild(createQuestionRow());
    });
    // Botón para agregar una nueva fila de pregunta
    document.getElementById('addRowBtn').addEventListener('click', () => {
      document.getElementById('questionsContainer').appendChild(createQuestionRow());
    });
    // Maneja el envío del formulario para agregar preguntas
    document.getElementById('addQuestionForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const asignatura = formData.get('asignatura');
      const tema = formData.get('tema');
      const usmle = formData.get('usmle') ? 'Sí' : '';
      // Recolecta los datos de cada fila
      const rows = document.querySelectorAll('#questionsContainer .question-row');
      let questions = [];
      rows.forEach(row => {
        const pregunta = row.querySelector('input[name="pregunta"]').value;
        const respuesta = row.querySelector('input[name="respuesta"]').value;
        const explicacion = row.querySelector('input[name="explicacion"]').value;
        const tipo = row.querySelector('select[name="tipo"]').value;
        questions.push({pregunta, respuesta, explicacion, tipo});
      });
      const data = {
        action: 'add',
        asignatura,
        tema,
        usmle,
        questions
      };
      fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      }).then(() => {
        alert('Preguntas enviadas correctamente.');
        // Aquí puedes limpiar el formulario o recargar la lista de preguntas
      }).catch(error => {
        alert('Error al enviar las preguntas.');
        console.error('Error:', error);
      });
    });
    // Función para cargar preguntas existentes desde el sheet
    function loadQuestions() {
      fetch(scriptURL + '?action=get')
        .then(response => response.json())
        .then(data => {
          const list = document.getElementById('questionsList');
          list.innerHTML = '';
          if(data && data.length) {
            let table = '<table><tr><th>Asignatura</th><th>Tema</th><th>ID</th><th>Pregunta</th><th>Respuesta</th><th>Explicación</th><th>Tipo</th><th>USMLE</th><th>Dificultad</th></tr>';
            data.forEach(item => {
              table += `<tr>
                <td>${item.Asignatura}</td>
                <td>${item.Tema}</td>
                <td>${item["id#"]}</td>
                <td>${item.Pregunta}</td>
                <td>${item.Respuesta}</td>
                <td>${item.Explicación}</td>
                <td>${item["Test o Flashcard"]}</td>
                <td>${item["USMLE?"]}</td>
                <td>${item.Dificultad}</td>
              </tr>`;
            });
            table += '</table>';
            list.innerHTML = table;
          } else {
            list.innerHTML = '<p>No hay preguntas disponibles.</p>';
          }
        })
        .catch(error => {
          console.error('Error al cargar las preguntas:', error);
        });
    }
    document.getElementById('refreshQuestions').addEventListener('click', loadQuestions);

    /* ---------------------------
       Navegación entre secciones
    -----------------------------*/
    document.getElementById('agregarTab').addEventListener('click', () => {
      document.getElementById('agregarSection').classList.remove('hidden');
      document.getElementById('estudiarSection').classList.add('hidden');
      document.getElementById('agregarTab').classList.add('active');
      document.getElementById('estudiarTab').classList.remove('active');
    });
    document.getElementById('estudiarTab').addEventListener('click', () => {
      document.getElementById('agregarSection').classList.add('hidden');
      document.getElementById('estudiarSection').classList.remove('hidden');
      document.getElementById('agregarTab').classList.remove('active');
      document.getElementById('estudiarTab').classList.add('active');
    });

    /* ---------------------------
       Sección: Estudiar Preguntas
    -----------------------------*/
    let studyQuestions = [];
    let currentIndex = 0;
    // Cargar preguntas para estudiar según filtros
    document.getElementById('loadStudyBtn').addEventListener('click', () => {
      const asignatura = document.getElementById('studyAsignatura').value;
      const tema = document.getElementById('studyTema').value;
      fetch(scriptURL + '?action=get')
        .then(response => response.json())
        .then(data => {
          studyQuestions = data.filter(q => {
            return (!asignatura || q.Asignatura.toLowerCase().includes(asignatura.toLowerCase())) &&
                   (!tema || q.Tema.toLowerCase().includes(tema.toLowerCase()));
          });
          if(studyQuestions.length === 0) {
            alert('No se encontraron preguntas para los filtros seleccionados.');
            return;
          }
          currentIndex = 0;
          showStudyQuestion();
          document.getElementById('studyInterface').classList.remove('hidden');
        })
        .catch(error => {
          console.error('Error al cargar preguntas para estudiar:', error);
        });
    });
    // Muestra la pregunta actual en la interfaz de estudio
    function showStudyQuestion() {
      const questionObj = studyQuestions[currentIndex];
      document.getElementById('questionProgress').textContent = `Pregunta ${currentIndex+1}/${studyQuestions.length}`;
      const card = document.getElementById('questionCard');
      const optionsContainer = document.getElementById('optionsContainer');
      const flipBtn = document.getElementById('flipCardBtn');
      card.innerHTML = '';
      optionsContainer.innerHTML = '';
      flipBtn.classList.add('hidden');
      if(questionObj["Test o Flashcard"] === 'T') {
        // Pregunta tipo test: separamos y barajamos las opciones.
        let options = questionObj.Respuesta.split("|");
        // La primera opción es la correcta
        const correctAnswer = options[0].trim();
        options = options.map(o => o.trim()).sort(() => Math.random() - 0.5);
        card.innerHTML = '<h3>' + questionObj.Pregunta + '</h3>';
        options.forEach(option => {
          const btn = document.createElement('button');
          btn.className = 'option';
          btn.textContent = option;
          btn.addEventListener('click', () => {
            if(option === correctAnswer) {
              btn.style.background = 'lightgreen';
              alert('¡Correcto!');
            } else {
              btn.style.background = 'lightcoral';
              alert('Incorrecto. La respuesta correcta es: ' + correctAnswer);
            }
          });
          optionsContainer.appendChild(btn);
        });
      } else {
        // Pregunta tipo flashcard: se muestra la pregunta y se ofrece voltear la tarjeta.
        card.innerHTML = '<h3>' + questionObj.Pregunta + '</h3>';
        flipBtn.classList.remove('hidden');
        flipBtn.onclick = () => {
          card.innerHTML = '<h3>' + questionObj.Pregunta + '</h3>' +
                           '<p><strong>Respuesta:</strong> ' + questionObj.Respuesta + '</p>' +
                           '<p><strong>Explicación:</strong> ' + questionObj.Explicación + '</p>';
          flipBtn.classList.add('hidden');
        };
      }
    }
    // Navegación entre preguntas
    document.getElementById('nextBtn').addEventListener('click', () => {
      if(currentIndex < studyQuestions.length - 1) {
        currentIndex++;
        showStudyQuestion();
      }
    });
    document.getElementById('prevBtn').addEventListener('click', () => {
      if(currentIndex > 0) {
        currentIndex--;
        showStudyQuestion();
      }
    });
    // Alternar modo día/noche
    document.getElementById('toggleDarkBtn').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
    });
    // Salir de la interfaz de estudio
    document.getElementById('exitStudyBtn').addEventListener('click', () => {
      document.getElementById('studyInterface').classList.add('hidden');
    });
    // Actualización de dificultad (se simula el envío al Apps Script)
    function updateDifficulty(difficulty) {
      const questionObj = studyQuestions[currentIndex];
      questionObj.Dificultad = difficulty;
      const data = {
        action: 'updateDifficulty',
        id: questionObj["id#"],
        dificultad: difficulty
      };
      fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      }).then(() => {
        alert('Dificultad actualizada a ' + difficulty);
      }).catch(error => {
        console.error('Error al actualizar dificultad:', error);
      });
    }
    document.getElementById('easyBtn').addEventListener('click', () => updateDifficulty('Fácil'));
    document.getElementById('mediumBtn').addEventListener('click', () => updateDifficulty('Medio'));
    document.getElementById('hardBtn').addEventListener('click', () => updateDifficulty('Difícil'));
  </script>
</body>
</html>
